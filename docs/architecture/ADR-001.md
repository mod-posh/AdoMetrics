# ADR-001: Canonical metrics engine with JSONL store

## Title

**ADR-001: Canonical metrics row + JSONL store as the core contract.**

### Status

- **Status:** Accepted (Implemented / Feature Complete)
- **Decision Date:** 2026-02-16
- **Decision Owner:** Jeffrey Patton

### Context

We want a reusable PowerShell module that can collect Azure DevOps pipeline run data and support multiple consumers (BAT today, others later). We need durability over time (multi-year history), incremental updates, and the ability to add fields later without breaking existing stores or tools.

Azure DevOps REST payloads can change, and consumers may not know all available fields up front. We need a stable internal representation.

### Decision

1. The moduleâ€™s primary architectural contract is a **canonical metric row** schema, produced from ADO build runs.
2. The canonical store format is **JSONL (JSON Lines)**:

   - Each line is one canonical metric row.
   - File can be appended/merged efficiently.
   - Multi-year persistence is supported.
3. Deduplication key for the store is:
   **`definitionId + adoBuildId`**.
4. Schema evolution is handled by an **idempotent schema repair** step during import (`Repair-AdoMetricRowSchema`) that:

   - Adds missing fields
   - Never overwrites existing fields by default

### Consequences

- Pros:

  - Durable, append-friendly storage
  - Simple incremental ingestion and reporting
  - Allows schema to evolve without rewriting history
- Cons:

  - JSONL is not directly parseable by `ConvertFrom-Json` as a whole file; we must provide import/export helpers.
  - Canonical schema must be maintained carefully as the core API contract.

### Out of scope

- Scheduling, Git commits, SharePoint upload, Excel generation (consumer responsibilities).
